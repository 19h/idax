name: Bindings CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read

env:
  IDA_SDK_REPO: HexRaysSA/ida-sdk
  BUILD_TYPE: Release

jobs:
  build-node:
    name: Node.js Bindings - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            msvc_arch: ''
          - os: windows-latest
            platform: win32
            arch: x64
            msvc_arch: x64
          - os: macos-14
            platform: darwin
            arch: arm64
            msvc_arch: ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: ${{ env.IDA_SDK_REPO }}
          path: ida-sdk
          submodules: recursive

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Install IDA Pro
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_KEY }}
        shell: bash
        run: |
          LICENSE_ID=$(uvx --from ida-hcli hcli --disable-updates license list | grep -oE "[0-9A-F]{2}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{2}" | head -n 1)
          echo "Using license ID: $LICENSE_ID"
          
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ASSET_KEY="release/9.3/ida-pro/ida-pro_93_x64win.exe"
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            ASSET_KEY="release/9.3/ida-pro/ida-pro_93_x64linux.run"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            if [[ "$(uname -m)" == "arm64" ]]; then
              ASSET_KEY="release/9.3/ida-pro/ida-pro_93_armmac.app.zip"
            else
              ASSET_KEY="release/9.3/ida-pro/ida-pro_93_x64mac.app.zip"
            fi
          fi
          
          mkdir -p ./ida-installer
          uvx --from ida-hcli hcli --disable-updates download --output-dir ./ida-installer "$ASSET_KEY"

          INSTALLER_FILE=$(python3 -c "import glob; files=sorted(glob.glob('ida-installer/*')); print(files[0] if files else '')")
          if [[ -z "$INSTALLER_FILE" ]]; then
            echo "error: no installer file found in ./ida-installer"
            ls -la ./ida-installer
            exit 1
          fi
          echo "Using installer file: $INSTALLER_FILE"
          uvx --from ida-hcli hcli --disable-updates ida install --set-default --accept-eula --yes --license-id "$LICENSE_ID" "$INSTALLER_FILE"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Resolve IDASDK and IDADIR paths
        shell: bash
        run: |
          SDK_ROOT="${GITHUB_WORKSPACE}/ida-sdk"
          if [[ -f "${SDK_ROOT}/ida-cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}" >> "$GITHUB_ENV"
          elif [[ -f "${SDK_ROOT}/src/cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}/src" >> "$GITHUB_ENV"
          elif [[ -f "${SDK_ROOT}/src/ida-cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}/src" >> "$GITHUB_ENV"
          elif [[ -f "${SDK_ROOT}/cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}" >> "$GITHUB_ENV"
          else
            echo "error: unable to locate SDK bootstrap.cmake in SDK checkout"
            exit 1
          fi

          IDADIR=$(python3 -c "import json, os; p = os.path.expanduser('~/.idapro/ida-config.json') if os.name != 'nt' else os.path.expandvars('%APPDATA%/Hex-Rays/IDA Pro/ida-config.json'); print(json.loads(open(p).read())['Paths']['ida-install-dir']) if os.path.exists(p) else print('')")
          if [[ "$RUNNER_OS" == "macOS" && -f "$IDADIR/Contents/MacOS/libida.dylib" ]]; then
            IDADIR="$IDADIR/Contents/MacOS"
          fi
          echo "IDADIR=$IDADIR" >> "$GITHUB_ENV"
          
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "$IDADIR" >> "$GITHUB_PATH"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "DYLD_LIBRARY_PATH=$IDADIR:$DYLD_LIBRARY_PATH" >> "$GITHUB_ENV"
            echo "DYLD_FALLBACK_LIBRARY_PATH=$IDADIR:$DYLD_FALLBACK_LIBRARY_PATH" >> "$GITHUB_ENV"
          else
            echo "LD_LIBRARY_PATH=$IDADIR:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
          fi

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Build idax static library
        shell: bash
        run: |
          mkdir build
          cd build
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cmake -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ..
          else
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ..
          fi
          cmake --build . --config ${{ env.BUILD_TYPE }}

      - name: Build Node Addon
        shell: bash
        working-directory: bindings/node
        run: |
          npm install --ignore-scripts
          npx cmake-js compile -v $(node -v | sed 's/v//')

      - name: Run Node examples (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: bindings/node
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export DYLD_LIBRARY_PATH="$IDADIR:$DYLD_LIBRARY_PATH"
          else
            export LD_LIBRARY_PATH="$IDADIR:$LD_LIBRARY_PATH"
          fi
          npm install ts-node typescript @types/node
          cp /bin/ls ./test_bin
          TEST_BIN="./test_bin"
          
          echo "Running idalib_dump_port..."
          npx ts-node examples/idalib_dump_port.ts "$TEST_BIN" --list

          echo "Running complexity_metrics..."
          npx ts-node examples/complexity_metrics.ts "$TEST_BIN"

          echo "Running class_reconstructor..."
          npx ts-node examples/class_reconstructor.ts "$TEST_BIN"

          echo "Running binary_forensics..."
          npx ts-node examples/binary_forensics.ts "$TEST_BIN"

      - name: Run Node examples (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: bindings/node
        run: |
          Write-Host "Skipping Node examples on Windows (headless instability under CI runtime)."

  build-rust:
    name: Rust Bindings - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            msvc_arch: ''
          - os: windows-latest
            msvc_arch: x64
          - os: macos-14
            msvc_arch: ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: ${{ env.IDA_SDK_REPO }}
          path: ida-sdk
          submodules: recursive

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Install IDA Pro
        env:
          HCLI_API_KEY: ${{ secrets.HCLI_KEY }}
        shell: bash
        run: |
          LICENSE_ID=$(uvx --from ida-hcli hcli --disable-updates license list | grep -oE "[0-9A-F]{2}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{2}" | head -n 1)
          echo "Using license ID: $LICENSE_ID"
          
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ASSET_KEY="release/9.3/ida-pro/ida-pro_93_x64win.exe"
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            ASSET_KEY="release/9.3/ida-pro/ida-pro_93_x64linux.run"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            if [[ "$(uname -m)" == "arm64" ]]; then
              ASSET_KEY="release/9.3/ida-pro/ida-pro_93_armmac.app.zip"
            else
              ASSET_KEY="release/9.3/ida-pro/ida-pro_93_x64mac.app.zip"
            fi
          fi
          
          mkdir -p ./ida-installer
          uvx --from ida-hcli hcli --disable-updates download --output-dir ./ida-installer "$ASSET_KEY"

          INSTALLER_FILE=$(python3 -c "import glob; files=sorted(glob.glob('ida-installer/*')); print(files[0] if files else '')")
          if [[ -z "$INSTALLER_FILE" ]]; then
            echo "error: no installer file found in ./ida-installer"
            ls -la ./ida-installer
            exit 1
          fi
          echo "Using installer file: $INSTALLER_FILE"
          uvx --from ida-hcli hcli --disable-updates ida install --set-default --accept-eula --yes --license-id "$LICENSE_ID" "$INSTALLER_FILE"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Resolve IDASDK and IDADIR paths
        shell: bash
        run: |
          SDK_ROOT="${GITHUB_WORKSPACE}/ida-sdk"
          if [[ -f "${SDK_ROOT}/ida-cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}" >> "$GITHUB_ENV"
          elif [[ -f "${SDK_ROOT}/src/cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}/src" >> "$GITHUB_ENV"
          elif [[ -f "${SDK_ROOT}/src/ida-cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}/src" >> "$GITHUB_ENV"
          elif [[ -f "${SDK_ROOT}/cmake/bootstrap.cmake" ]]; then
            echo "IDASDK=${SDK_ROOT}" >> "$GITHUB_ENV"
          else
            echo "error: unable to locate SDK bootstrap.cmake in SDK checkout"
            exit 1
          fi

          IDADIR=$(python3 -c "import json, os; p = os.path.expanduser('~/.idapro/ida-config.json') if os.name != 'nt' else os.path.expandvars('%APPDATA%/Hex-Rays/IDA Pro/ida-config.json'); print(json.loads(open(p).read())['Paths']['ida-install-dir']) if os.path.exists(p) else print('')")
          if [[ "$RUNNER_OS" == "macOS" && -f "$IDADIR/Contents/MacOS/libida.dylib" ]]; then
            IDADIR="$IDADIR/Contents/MacOS"
          fi
          echo "IDADIR=$IDADIR" >> "$GITHUB_ENV"
          
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "$IDADIR" >> "$GITHUB_PATH"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "DYLD_LIBRARY_PATH=$IDADIR:$DYLD_LIBRARY_PATH" >> "$GITHUB_ENV"
            echo "DYLD_FALLBACK_LIBRARY_PATH=$IDADIR:$DYLD_FALLBACK_LIBRARY_PATH" >> "$GITHUB_ENV"
          else
            echo "LD_LIBRARY_PATH=$IDADIR:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
          fi

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake clang libclang-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> "$GITHUB_ENV"

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          choco install llvm
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> "$GITHUB_ENV"

      - name: Build Rust bindings (Unix)
        if: runner.os != 'Windows'
        working-directory: bindings/rust
        shell: bash
        run: |
          cargo build --verbose
          cargo build --examples --verbose

      - name: Build Rust bindings (Windows)
        if: runner.os == 'Windows'
        working-directory: bindings/rust
        shell: pwsh
        run: |
          cargo build --release --verbose
          cargo build --release --examples --verbose

      - name: Run Rust examples (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: bindings/rust
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export DYLD_LIBRARY_PATH="$IDADIR:$DYLD_LIBRARY_PATH"
          else
            export LD_LIBRARY_PATH="$IDADIR:$LD_LIBRARY_PATH"
          fi
          
          cp /bin/ls ./test_bin
          TEST_BIN="./test_bin"
          
          echo "Running idalib_dump_port..."
          cargo run --example idalib_dump_port -- "$TEST_BIN" --list

          echo "Running ida2py_port..."
          cargo run --example ida2py_port -- "$TEST_BIN"

      - name: Run Rust examples (Windows)
        if: runner.os == 'Windows'
        working-directory: bindings/rust
        shell: pwsh
        run: |
          $env:PATH = "$env:IDADIR;$env:PATH"
          $env:IDAUSR = "$pwd\idax_empty_user"
          New-Item -ItemType Directory -Force -Path $env:IDAUSR | Out-Null
          $env:IDAX_RUST_EXAMPLE_TRACE = "1"
          $env:IDAX_RUST_DISABLE_ANALYSIS = "1"
          Copy-Item "C:\Windows\System32\notepad.exe" "test_bin.exe"
          $testBin = ".\test_bin.exe"

          function Invoke-RustExample {
            param(
              [Parameter(Mandatory = $true)] [string] $Name,
              [Parameter(Mandatory = $true)] [string[]] $Args
            )

            Write-Host "Building $Name..."
            cargo build --release --example $Name
            if ($LASTEXITCODE -ne 0) {
              throw "build failed for $Name"
            }

            $exe = "target\release\examples\$Name.exe"
            Write-Host "Running $Name..."
            & $exe @Args
            $code = $LASTEXITCODE
            if ($code -ne 0) {
              $hex = ('0x{0:X8}' -f [uint32]$code)
              throw "$Name failed with exit code $code ($hex)"
            }
          }

          Invoke-RustExample -Name "idalib_dump_port" -Args @($testBin, "--list")
          Invoke-RustExample -Name "ida2py_port" -Args @($testBin)
